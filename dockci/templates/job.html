{% extends "_base.html" %}
{% block title %}{{ job.project.name }} Job Result{% endblock %}
{% block header %}
  <a href="/projects/{{ job.project.slug }}">{{ job.project.name }}</a> <small>{{ job.create_ts }}</small>
  <span class="pull-right" id="job-state">{{ job_state_glyph(job.state) }}</span>
{% endblock %}
{% block content %}
<ul class="nav nav-pills" role="tablist" style="position:absolute; right: 0; z-index: 10">
  <li role="presentation" class="active"><a href="#job-details" role="tab" data-toggle="tab"><i class="mdi-action-list"></i></a></li>
  <li role="presentation"><a href="#job-output" role="tab" data-toggle="tab"><i class="mdi-file-cloud-download"></i></a></li>
</ul>
<div class="tab-content">
  <div role="tabpanel" class="tab-pane active form-horizontal" id="job-details">
    <div class="form-group">
      <label class="col-sm-2 control-label">Repo</label>
      <div class="col-sm-10"><p class="form-control-static">{{ job.repo }}</p></div>
    </div>
    <div class="form-group">
      <!-- This will update to a full hash after the git_info stage -->
      <label class="col-sm-2 control-label">Commit ref</label>
      <div class="col-sm-10"><p class="form-control-static">{{ job.commit }}</p></div>
    </div>
    {% if job.git_author_name or job.git_author_email %}<div class="form-group">
      <label class="col-sm-2 control-label">Author</label>
      <div class="col-sm-10"><p class="form-control-static">{{ git_user(job.git_author_name, job.git_author_email) }}</div>
    </div>{% endif %}
    {% if (job.git_committer_name or job.git_committer_email) and (job.git_committer_name != job.git_author_name or job.git_committer_email != job.git_author_email) %}<div class="form-group">
      <label class="col-sm-2 control-label">Committer</label>
      <div class="col-sm-10"><p class="form-control-static">{{ git_user(job.git_committer_name, job.git_committer_email) }}</div>
    </div>{% endif %}
    {% if job.tag %}<div class="form-group">
      <label class="col-sm-2 control-label">Tag</label>
      <div class="col-sm-10"><p class="form-control-static">{{ job.tag }}</p></div>
    </div>{% endif %}
    {% if job.has_value('ancestor_job_slug') %}<div class="form-group">
      <label class="col-sm-2 control-label">Previous job</label>
      <div class="col-sm-10"><p class="form-control-static">
        <a href="/projects/{{ job.project.slug }}/jobs/{{ job.ancestor_job.slug }}">{{ job.ancestor_job_slug }}</a>
      </p></div>
    </div>{% endif %}
    {% if job.image_id %}<div class="form-group">
      <label class="col-sm-2 control-label">Image ID</label>
      <div class="col-sm-10"><p class="form-control-static">{{ job.image_id }}</p></div>
    </div>{% endif %}
    {% if job.container_id %}<div class="form-group">
      <label class="col-sm-2 control-label">Container ID</label>
      <div class="col-sm-10"><p class="form-control-static">{{ job.container_id }}</p></div>
    </div>{% endif %}
    {% if job.exit_code %}<div class="form-group">
      <label class="col-sm-2 control-label">Exit Code</label>
      <div class="col-sm-10"><p class="form-control-static">{{ job.exit_code }}</p></div>
    </div>{% endif %}
  </div>
  <div role="tabpanel" class="tab-pane form-horizontal" id="job-output">
    <style>
      .job-output-download:hover {
        padding-right: 20px;
      }
      .job-output-download:hover::after {
        content: ' - download tar';
      }
      .stage-panel .panel-heading {
        transition: all 1s;
      }
      .panel-contracted .panel-body {
        display: none;
        overflow: scroll;
      }
      .stage-panel .expand-toggle:before {
        /* TODO SASS include mdi icon */
        content: '-';
        width: 1em;
        display: inline-block;
      }
      .panel-contracted .expand-toggle:before {
        /* TODO SASS include mdi icon */
        content: '+';
      }
      #auto-scroll {
        position: fixed;
        bottom: 20px;
        right: 20px;
      }
    </style>
    {% for name, details in job.job_output_details.items() %}
      <div class="form-group">
        <label class="col-sm-2 control-label">{{ name }}</label>
        <div class="col-sm-10"><p class="form-control-static">
          <a href="{{ details.link }}" class="job-output-download">{{ details.size }}</a>
        </p></div>
      </div>
    {% else %}
      <div class="alert alert-info">No items!</div>
    {% endfor %}
  </div>
</div>
<h2>Job Log</h2>
<div id="job-stages"></div>
<div id="auto-scroll" class="btn btn-info btn-fab"><i class="mdi-editor-vertical-align-bottom"></i></div>
<script>
  function dockciJob() {
    var stageAjaxQueue = {},
        importantPanels = ['docker_build', 'docker_test', 'error'],
        dockerStages = ['docker_provision', 'docker_build', 'docker_push', /^utility_.*/],
        lenientDockerStages = [/^utility_.*/],
        scrollEnabled = false, scrollAnimation = null, maxScroll = 0;

    // Turn panel slugs into classes
    $.each(importantPanels, function(idx, slug) {
      importantPanels[idx] = 'stage-panel-' + slug;
    })

    function getExistingStageEl(slug) {
      var existing = $('.stage-panel-' + slug);

      if (existing.length > 0) {
        return existing;
      }
    }
    function createNewStageEl(idx, slug) {
      var created = $('<div></div>')
        .addClass('stage-panel panel panel-info stage-panel-' + slug)
        .append(
          $('<div></div>')
            .addClass('panel-heading')
            .text(slug)
            .append(
              $('<i></i>').addClass('expand-toggle pull-right').hide()
            )
            .append(
              $('<i></i>').addClass('loading mdi-device-data-usage spin pull-right')
            )
            .click(function(ev) {
              $(ev.currentTarget).parent().toggleClass('panel-contracted');
            })
        )
        .append(
          $('<pre></pre>').addClass('panel-body stage-log')
        );

      // Contract unimportant panels
      $('.stage-panel').each(function(idx, el) {
        var isImportant = false,
            allImportant = importantPanels.concat(['panel-danger']);
        el = $(el)
        $.each(allImportant, function(s_idx, panelClass) {
          if (el.hasClass(panelClass)) {
            isImportant = true
            return false
          }
        })
        if (!isImportant) {
          el.addClass('panel-contracted');
        }
      })

      $('#job-stages').append(created);

      return created
    }
    function scrollToBottom() {
      if (!scrollEnabled) { return; }

      if (maxScroll < $(document).height()) {
          maxScroll = $(document).height();
          if (scrollAnimation !== null) { scrollAnimation.stop(true); }
          scrollAnimation = $("html, body").animate({
            scrollTop: maxScroll
          }, 100);
      }
    }
    function dockerIdText(lineId) {
      stageSlug = dockerStages.find(function(el) {
        return lineId.indexOf(el + '_') === 0;
      })
      if (typeof(stageSlug) !== 'undefined') {
        return lineId.substr(stageSlug.length + 1);
      }
      return lineId;
    }
    function dockerJobLine(panelEl, logEl, obj, lenient) {
      var idRow, objLine, errorMessage
          isObj = typeof(obj) === 'object';

      if (isObj && ('errorDetail' in obj || 'error' in obj)) {
        if ('errorDetail' in obj) {
            errorMessage = obj['errorDetail']['message'];
        } else {
            errorMessage = obj['error'];
        }
        logEl.append(
          '<div class="docker-log-error alert alert-danger">' +
          ansi_up.ansi_to_html(errorMessage) +
          '</div>'
        );
        panelEl.removeClass('panel-info panel-contracted')
        panelEl.addClass('panel-danger');

      } else if (isObj && 'stream' in obj) {

        lineEl = $('.docker-log-stream:last', logEl);
        if (lineEl.length === 0) {
          lineEl = $('<div class="docker-log-stream"></div>');
          logEl.append(lineEl);
        }

        lineEl.html(lineEl.html() + ansi_up.ansi_to_html(obj['stream']));

        if (obj['stream'].endsWith('\n')) {
          logEl.append('<div class="docker-log-stream"></div>');
        }

      } else if (isObj && 'id' in obj) {
        idRow = $('.docker-log-' + obj['id'], logEl);
        if (idRow.length < 1) {
          idRow = $('<div class="docker-log-' + obj['id'] + '"></div>');
          logEl.append(idRow);
        }

        messageComps = [dockerIdText(obj['id'])]
        if ('status' in obj) { messageComps.push(ansi_up.ansi_to_html(obj['status'])) }
        if ('progress' in obj) { messageComps.push(ansi_up.ansi_to_html(obj['progress'])) }

        idRow.html(messageComps.join(' | '))
      } else if (isObj && 'status' in obj) {
        logEl.append(
          '<div class="docker-log-status">' +
          ansi_up.ansi_to_html(obj['status']) +
          '</div>'
        );
      } else {
        if (isObj) {
          objLine = JSON.stringify(obj);
        } else {
          objLine = obj;
        }
        if (lenient) {
          logEl.append('<div>' + objLine + '</div>');
        } else {
          logEl.append('<div style="color: red">' + objLine + '</div>');
        }
      }
    }
    function testMatches(matchList, search) {
      var idx = 0
      for (idx = 0; idx < matchList.length; idx++) {
        if (matchList[idx] instanceof RegExp) {
          return matchList[idx].test(search)
        }
      }
      return false
    }
    function isDockerStage(stageSlug) {
      if (dockerStages.indexOf(stageSlug) !== -1) { return true }
      return testMatches(dockerStages, stageSlug)
    }
    function isLenientDockerStage(stageSlug) {
      return testMatches(lenientDockerStages, stageSlug)
    }
    function processNextStage() {
      var sortedQueueIndexes = Object.keys(stageAjaxQueue).sort(),
          incompleteLineBuffer = "", processedChars = 0,
          lenient, stageData;

      if (sortedQueueIndexes.length === 0) {
        return
      }

      stageData = stageAjaxQueue[sortedQueueIndexes[0]]
      delete stageAjaxQueue[sortedQueueIndexes[0]]

      lenient = isLenientDockerStage(stageData['slug'])

      $.ajax({
        url: '/projects/{{ job.project.slug }}/jobs/{{ job.slug }}/output/' + stageData['slug'] + '.log',
        xhrFields: {
          onprogress: function(e) {
            var logEl = $('.panel-body', stageData['stageEl']),
                responseText = e.target.responseText,
                responseLines;

            totalLength = responseText.length;
            responseText = responseText.substr(processedChars,
                                               responseText.length);
            responseLines = responseText.split('\n');
            processedChars = totalLength;

            if (isDockerStage(stageData['slug'])) {
              // Combine the first line with the previous incomplete line
              responseLines[0] = incompleteLineBuffer + responseLines[0];

              // Last value is always incomplete
              incompleteLineBuffer = responseLines.pop();

              $.each(responseLines, function(idx, value) {
                if (value === '') { return; }
                try {
                  value = $.parseJSON(value);
                } catch (err) {}

                dockerJobLine(stageData['stageEl'], logEl, value, lenient);
              }, '');
            } else {
              lastLine = $('div:last', logEl)
              if (lastLine.length !== 0) {
                lineCompletion = responseLines.shift();
                lastLine.text(lastLine.text() + lineCompletion);
              }
              $.each(responseLines, function(idx, value) {
                content = ansi_up.ansi_to_html(value);
                if (content === '') {
                    content = '&nbsp;';
                }
                logEl.append($('<div>' + content + '</div>'));
              })
            }

            scrollToBottom();
          }
        },
        complete: function(jqXHR, textStatus) {
          $('i.loading', stageData['stageEl']).hide();
          $('i.expand-toggle', stageData['stageEl']).show();
          processNextStage();
          refreshJobInfo();
        },
        success: function(jqXHR, textStatus) {
          var panelClass = 'panel-success';
          if (stageData['slug'] == 'error') {
            panelClass = 'panel-danger';
          }

          stageData['stageEl'].removeClass('panel-info');
          stageData['stageEl'].addClass(panelClass);
        },
        error: function(jqXHR, textStatus, errorText) {
          var stagePanelHeadingEl = $('.panel-heading', stageData['stageEl'])
          stagePanelHeadingEl.text(stageData['slug'] + ' - ' + errorText);
          stageData['stageEl'].removeClass('panel-info');
          stageData['stageEl'].addClass('panel-danger');
        }
      })
    }
    function queueStageLoad(idx, stageEl, slug) {
      stageAjaxQueue[idx] = {'stageEl': stageEl,
                             'slug':    slug
                             }
      if (Object.keys(stageAjaxQueue).length == 1) {
        processNextStage()
      }
    }

    function refreshJobInfo() {
      $.ajax({
        url: '/projects/{{ job.project.slug }}/jobs/{{ job.slug }}.json',
        dataType: 'json',
        success: function(data, textStatus, jqXHR) {
          var stageEl;
          $.each(data.job_stage_slugs, function(idx, slug) {
            if (! getExistingStageEl(slug)) {
              stageEl = createNewStageEl(idx, slug);
              queueStageLoad(idx, stageEl, slug);
            }
          })
        }
      });
    }

    $('#auto-scroll').click(function() {
      var icon = $('i', this)
      scrollEnabled = ! scrollEnabled;
      scrollToBottom();
      icon.toggleClass('mdi-device-data-usage spin', scrollEnabled);
      icon.toggleClass('mdi-editor-vertical-align-bottom', !scrollEnabled);
    });

    refreshJobInfo()
  };
  dockciJob();
</script>
{% endblock %}
